Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  config.vm.hostname = "k8s-worker-1"

  # (선택) 추가 NIC가 필요하면 DHCP로 하나 더 붙이기
  # - 같은 L2/172.16.1.x로 붙이려면 브리지 구성이 필요해서 일단 DHCP 예시만 남김
  # config.vm.network "private_network", type: "dhcp"

  config.vm.provider :libvirt do |lv|
    lv.cpus = 2
    lv.memory = 4096
    lv.disk_bus = "virtio"
    lv.nic_model_type = "virtio"
  end

  # control-plane 정보 (현재 사용한 값)
  CP_ENDPOINT = "172.16.1.21:6443"
  JOIN_TOKEN  = "fcajfu.7k0yxbpbsmlafk8f"
  CA_HASH     = "sha256:34e5b9f377b582e752699df966ad39665bc9ff997867d8459a8dca52eb2e98c0"

  config.vm.provision "shell", privileged: true, inline: <<-SHELL
    set -euxo pipefail

    # 0) swap off
    swapoff -a || true
    sed -i '/\\sswap\\s/ s/^/#/' /etc/fstab || true

    # 1) sysctl (ip_forward + br_netfilter)
    modprobe br_netfilter || true
    cat >/etc/sysctl.d/99-kubernetes.conf <<'EOF'
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
    sysctl --system

    # 2) containerd
    apt-get update
    apt-get install -y containerd

    mkdir -p /etc/containerd
    containerd config default > /etc/containerd/config.toml
    sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
    systemctl enable --now containerd

    # 3) kubeadm/kubelet/kubectl (v1.30.14 고정)
    apt-get install -y apt-transport-https ca-certificates curl gpg
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
    apt-get update

    apt-get install -y kubelet=1.30.14-1.1 kubeadm=1.30.14-1.1 kubectl=1.30.14-1.1
    apt-mark hold kubelet kubeadm kubectl

    # 4) join (이미 조인되어 있으면 스킵)
    if [ -f /etc/kubernetes/kubelet.conf ]; then
      echo "[INFO] already joined. skip kubeadm join."
      exit 0
    fi

    kubeadm join #{CP_ENDPOINT} --token #{JOIN_TOKEN} --discovery-token-ca-cert-hash #{CA_HASH}
  SHELL
end
